"use strict";var app=angular.module("geolfApp",[]);app.config(["$routeProvider",function(a){a.when("/",{templateUrl:"views/main.html",controller:"MainCtrl"}).otherwise({redirectTo:"/"})}]),app.controller("MainCtrl",["$scope","geotracker","geomath","places","mapping",function(a,b,c,d,e){a.state="Initializing",a.init=function(){b.start()},a.initializeGreen=function(){a.state="Initializing",e.create(),e.addMarker("me","me"),d.search(500,a.onPlaces)},a.findBall=function(){e.animateCameraTo(a.ball.coords,{animation:"arc",returnToOriginal:!0},function(){console.log("done")})},a.swing=function(){a.ball||(a.ball=e.addMarker("ball","ball")),a.state="animating",e.animateMarkerBy(a.ball,a.power,a.direction,{animation:"arc"},function(){a.state="GamePlay",a.ball.distanceTo=c.calculateDistance(b.geo.coords,a.ball.coords),a.ball.bearingTo=c.calculateBearing(b.geo.coords,a.ball.coords)-90,a.$apply()})},a.onPlaces=function(){a.state="GamePlay";var b=d.getFarthest();e.addMarker("loc",b.name,b.location),a.$apply()},a.init()}]),app.service("geotracker",function(){var a=this;this.config={enableHighAccuracy:!0,maximumAge:5e3},this.listeners=[],this.start=function(b){b&&(a.config=b),navigator.geolocation.watchPosition(a.updated,a.error,a.config)},this.subscribe=function(b){a.listeners.push(b)},this.updated=function(b){a.accuracy=b.coords.accuracy,a.geo=b,a.listeners.forEach(function(a){a.apply(this,[b])})},this.error=function(a){switch(a.code){case a.PERMISSION_DENIED:console.log("User denied the request for Geolocation.");break;case a.POSITION_UNAVAILABLE:console.log("Location information is unavailable.");break;case a.TIMEOUT:console.log("The request to get user location timed out.");break;case a.UNKNOWN_ERROR:console.log("An unknown error occurred.")}}}),app.service("places",["$http","geotracker","geomath","mapping",function(a,b,c,d){var e=this;e.places=[],this.config={providerName:"GooglePlaces"},this.init=function(){b.subscribe(e.updateDistances)},this.search=function(a,c){if(e.callback=c,"GooglePlaces"==e.config.providerName){var f=new google.maps.LatLng(b.geo.coords.latitude,b.geo.coords.longitude),g=new google.maps.places.PlacesService(d.map);g.nearbySearch({radius:a,location:f},e._onPlacesFound)}},this.getClosest=function(){return 0==e.places.length?null:e.places[0]},this.getFarthest=function(){return 0==e.places.length?null:e.places[e.places.length-1]},this.sortByProximity=function(){e.places=e.places.sort(function(a,b){return a.distance-b.distance})},this.updateDistances=function(){b.geo&&e.places&&(e.places.forEach(function(a){a.distance=c.calculateDistance(a.location,b.geo.coords)}),e.sortByProximity())},this._onPlacesFound=function(a){"GooglePlaces"==e.config.providerName&&a.forEach(function(a){var b={location:{latitude:a.geometry.location.lb,longitude:a.geometry.location.mb},name:a.name};e.places.push(b)}),e.updateDistances(),e.callback.apply(this,[e.places])},this.init()}]),app.service("mapping",["$http","geotracker","geomath",function(a,b,c){var d=this;this.markers={},this.config={google:{zoom:16,mapTypeId:google.maps.MapTypeId.SATELLITE,disableDefaultUI:!0},animationSteps:100,closeUpZoom:20,cameraAnimationSteps:100},this.addMarker=function(a,c,e){e||(e=b.geo.coords),d.markers[c]=d._markerFactory(a);var f=new google.maps.LatLng(e.latitude,e.longitude);return d.markers[c].setPosition(f),{marker:d.markers[c],coords:e}},this.animateCameraTo=function(a,b,e){for(var f=c.calculateDistance(d.map.getCenter(),a),g=c.calculateBearing(d.map.getCenter(),a),h=f/d.config.cameraAnimationSteps,i=[],j=0;j<d.config.cameraAnimationSteps;j++){var k={};k.coords=c.projectOut(d.map.getCenter(),h*j,g+180),i.push(k)}for(var j=0;j<d.config.cameraAnimationSteps;j++){var k={};(b.animation="arc")&&(k.zoom=parseInt(d.map.getZoom()+(d.config.closeUpZoom-d.map.getZoom())*Math.sin(j/d.config.cameraAnimationSteps*Math.PI/2))),i.push(k)}1==b.returnToOriginal&&(i.push({pause:20}),i=i.concat(i.slice(0).reverse())),d._startAnimation(i,"camera",d.map,e)},this.animateMarkerBy=function(a,b,e,f,g){for(var h=b/d.config.animationSteps,i=[],j=0;j<d.config.animationSteps;j++){var k={};k.coords=c.projectOut(a.coords,h*j,e-90),(f.animation="arc")&&(k.size=a.marker.icon.size.width*Math.sin(j/d.config.animationSteps*Math.PI)+a.marker.icon.size.width),i.push(k)}i.reverse(),d._startAnimation(i,"marker",a,g)},this.moveMarkerTo=function(a,b){a.marker.setPosition(new google.maps.LatLng(b.latitude,b.longitude)),a.coords=b},this.moveMarkerBy=function(a,b,d){var e=c.projectOut(a.coords,b,d);this.moveMarkerTo(a,e)},this.create=function(a){if(a)d.config.google.center=a;else{var c=new google.maps.LatLng(b.geo.coords.latitude,b.geo.coords.longitude);d.config.google.center=c}return d.map=new google.maps.Map(document.getElementById("map-canvas"),d.config.google),d.map},this._startAnimation=function(a,b,c,e){var f=0,g=0,h=function(){if(f>0)return f--,requestAnimationFrame(h),void 0;if(0==a.length)return e&&e.apply(this),void 0;var i=a.pop();if(i.pause)return f=i.pause-1,requestAnimationFrame(h),void 0;switch(b){case"marker":i.size&&(c.marker.icon.scaledSize=new google.maps.Size(i.size,i.size),c.marker.icon.size=new google.maps.Size(i.size,i.size)),d.moveMarkerTo(c,i.coords);break;case"camera":i.zoom&&i.zoom!=g&&(g=i.zoom,c.setZoom(i.zoom)),i.coords&&c.panTo(new google.maps.LatLng(i.coords.latitude,i.coords.longitude))}requestAnimationFrame(h)};requestAnimationFrame(h)},this._markerFactory=function(a){switch(a){case"me":return new google.maps.Marker({map:d.map,icon:new google.maps.MarkerImage("images/player.png",new google.maps.Size(40,60),new google.maps.Point(0,0),new google.maps.Point(Math.floor(20),Math.floor(30)),new google.maps.Size(40,60))});case"ball":return new google.maps.Marker({map:d.map,icon:new google.maps.MarkerImage("images/golf-ball.png",new google.maps.Size(15,15),new google.maps.Point(0,0),new google.maps.Point(Math.floor(7.5),Math.floor(7.5)),new google.maps.Size(15,15))});default:return new google.maps.Marker({map:d.map})}}}]),app.service("geomath",function(){var a=this,b=6371e3;this.calculateDistance=function(c,d){a.convertFromGoogle([c,d]);var e=a.toRad(c.latitude-d.latitude),f=a.toRad(c.longitude-d.longitude),g=a.toRad(d.latitude),h=a.toRad(c.latitude),i=Math.sin(e/2)*Math.sin(e/2)+Math.sin(f/2)*Math.sin(f/2)*Math.cos(g)*Math.cos(h),j=2*Math.atan2(Math.sqrt(i),Math.sqrt(1-i));return parseInt(b*j)},this.calculateBearing=function(b,c){a.convertFromGoogle([b,c]),a.toRad(b.latitude-c.latitude);var d=a.toRad(b.longitude-c.longitude),e=a.toRad(c.latitude),f=a.toRad(b.latitude),g=Math.sin(d)*Math.cos(f),h=Math.cos(e)*Math.sin(f)-Math.sin(e)*Math.cos(f)*Math.cos(d),i=a.toDeg(Math.atan2(g,h));return i},this.projectOut=function(c,d,e){a.convertFromGoogle([c]);var f=a.toRad(c.latitude),g=a.toRad(c.longitude),e=a.toRad(e),h=Math.asin(Math.sin(f)*Math.cos(d/b)+Math.cos(f)*Math.sin(d/b)*Math.cos(e)),i=g+Math.atan2(Math.sin(e)*Math.sin(d/b)*Math.cos(f),Math.cos(d/b)-Math.sin(f)*Math.sin(h));return{latitude:a.toDeg(h),longitude:a.toDeg(i)}},this.convertFromGoogle=function(a){a.forEach(function(a){a.lb&&a.mb&&(a.latitude=a.lb,a.longitude=a.mb)})},this.toRad=function(a){return a*Math.PI/180},this.toDeg=function(a){return 180*a/Math.PI}}),app.directive("compass",function(){return{restrict:"E",link:function(a,b,c){c.$observe("direction",function(a){b.css("transform","rotate("+a+"deg)")})}}});